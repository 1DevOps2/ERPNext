name: deploy erp app

on:
  push:
    branches: [ "erpnext-with-github-actions" ]

jobs:
  deploy-erp:
    runs-on: ubuntu-latest

    steps:
    # - name: install ssh keys
    #   run: |
    #     install -m 600 -D /dev/null ~/.ssh/id_rsa
    #     echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
    #     ssh-keyscan -H ${{ secrets.SSH_HOST }} > ~/.ssh/known_hosts

    # - name: Create SSH config file
    #   run: |
    #         echo "Host *" > ~/.ssh/config
    #         echo "    ServerAliveInterval 20" >> ~/.ssh/config
    #         echo "    TCPKeepAlive no" >> ~/.ssh/config
            
    - name: SSH and run commands
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.SSH_HOST }}
        username: ${{ secrets.SSH_USER }}
        password: ${{ secrets.SSH_PASSWORD }}
        # port: 22
        script: |
            # installing docker
            for pkg in docker.io docker-doc docker-compose docker-compose-v2 podman-docker containerd runc; do sudo apt-get remove $pkg; done
            sudo apt-get update
            sudo apt-get install ca-certificates curl gnupg
            sudo install -m 0755 -d /etc/apt/keyrings
            curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /etc/apt/keyrings/docker.gpg
            sudo chmod a+r /etc/apt/keyrings/docker.gpg
            echo \
              "deb [arch="$(dpkg --print-architecture)" signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu \
              "$(. /etc/os-release && echo "$VERSION_CODENAME")" stable" | \
              sudo tee /etc/apt/sources.list.d/docker.list > /dev/null
            sudo apt-get update 
            sudo apt-get install docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin

            # installing git
            sudo apt-get install git -y

            # clone the project
            git clone -b erpnext-with-github-actions https://github.com/1DevOps2/ERPNext.git 

            # run the docker containers
            cd ERPNext && docker-compose up --build -d

    - name: cleanup
      run: rm -rf ~/.ssh
